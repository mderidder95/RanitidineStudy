DBMS:
sqlite

Error:
no such table: main.test

SQL:
CREATE TEMP TABLE qualified_events

AS
WITH primary_events (event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id)  AS (
-- Begin Primary Events
select P.ordinal as event_id, P.person_id, P.start_date, P.end_date, op_start_date, op_end_date, cast(P.visit_occurrence_id as bigint) as visit_occurrence_id
FROM
(
  select E.person_id, E.start_date, E.end_date,
         row_number() OVER (PARTITION BY E.person_id ORDER BY E.sort_date ASC) ordinal,
         OP.observation_period_start_date as op_start_date, OP.observation_period_end_date as op_end_date, cast(E.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM 
  (
  -- Begin Drug Exposure Criteria
select C.person_id, C.drug_exposure_id as event_id, C.drug_exposure_start_date as start_date,
       COALESCE(C.drug_exposure_end_date, CAST(STRFTIME('%s', DATETIME(C.drug_exposure_start_date, 'unixepoch', (1)||' days')) AS REAL)) as end_date, C.drug_concept_id as TARGET_CONCEPT_ID, C.visit_occurrence_id,
       C.drug_exposure_start_date as sort_date
from 
(
  select de.* 
  FROM main.DRUG_EXPOSURE de
JOIN temp.Codesets codesets on ((de.drug_concept_id = codesets.concept_id and codesets.codeset_id = 0))
) C
JOIN main.PERSON P on C.person_id = P.person_id
WHERE STRFTIME('%Y', C.drug_exposure_start_date, 'unixepoch') - P.year_of_birth >= 0
AND P.gender_concept_id in (8532,8507)
-- End Drug Exposure Criteria

  ) E
	JOIN main.test OP on E.person_id = OP.person_id and E.start_date >=  OP.observation_period_start_date and E.start_date <= op.observation_period_end_date
  WHERE CAST(STRFTIME('%s', DATETIME(OP.OBSERVATION_PERIOD_START_DATE, 'unixepoch', (0)||' days')) AS REAL) <= E.START_DATE AND CAST(STRFTIME('%s', DATETIME(E.START_DATE, 'unixepoch', (0)||' days')) AS REAL) <= OP.OBSERVATION_PERIOD_END_DATE
) P
WHERE P.ordinal = 1
-- End Primary Events

)
 SELECT
event_id, person_id, start_date, end_date, op_start_date, op_end_date, visit_occurrence_id

FROM
(
  select pe.event_id, pe.person_id, pe.start_date, pe.end_date, pe.op_start_date, pe.op_end_date, row_number() over (partition by pe.person_id order by pe.start_date ASC) as ordinal, cast(pe.visit_occurrence_id as bigint) as visit_occurrence_id
  FROM primary_events pe
  
) QE



R version:
R version 4.0.4 (2021-02-15)

Platform:
x86_64-w64-mingw32

Attached base packages:
- stats
- graphics
- grDevices
- utils
- datasets
- methods
- base

Other attached packages:
- DrugUtilization (1.0.0)
- DatabaseConnector (5.0.0)
- ggiraph (0.8.2)
- tidyr (1.2.0)
- readr (2.1.2)
- dplyr (1.0.7)
- tibble (3.1.6)